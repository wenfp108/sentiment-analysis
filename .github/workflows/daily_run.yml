name: Woonbot Sentinel (Direct-Sync)

on:
  schedule:
    - cron: '43 */4 * * *'  # æ¯ 4 å°æ—¶ (UTCæ—¶é—´)
  workflow_dispatch:        # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: read  # åªéœ€è¦è¯»å½“å‰åº“

jobs:
  analyze-and-sync:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ æ‹‰å–ä»£ç 
      uses: actions/checkout@v3

    - name: ğŸ è®¾ç½® Python (é«˜é€Ÿç¼“å­˜)
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
        cache-dependency-path: streamlit-app/requirements.txt

    - name: ğŸ§  ç¼“å­˜ NLTK æ•°æ®
      uses: actions/cache@v3
      with:
        path: ~/nltk_data
        key: ${{ runner.os }}-nltk-v1
    
    - name: ğŸ§  ç¼“å­˜ HuggingFace æ¨¡å‹
      uses: actions/cache@v3
      with:
        path: ~/.cache/huggingface
        key: ${{ runner.os }}-huggingface-v1

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        # å®‰è£…æ ¸å¿ƒä¾èµ–
        pip install requests textblob praw transformers torch pandas numpy
        # å®‰è£…é¡¹ç›®ä¾èµ– (å¦‚æœæœ‰é¢å¤–çš„)
        if [ -f "streamlit-app/requirements.txt" ]; then
          pip install -r streamlit-app/requirements.txt
        fi
        # ä¸‹è½½è¯­æ–™åº“ (æœ‰ç¼“å­˜æ—¶ä¼šè‡ªåŠ¨è·³è¿‡)
        if [ ! -d "$HOME/nltk_data" ]; then
          python -m textblob.download_corpora
        fi

    - name: ğŸ¤– è¿è¡Œå¹¶åŒæ­¥è‡³é“¶è¡Œ
      env:
        # âš ï¸ å…³é”®ï¼šè¿™é‡Œå¿…é¡»ä½¿ç”¨ GH_PAT
        GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        
        # Reddit å¯†é’¥
        REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
        REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
        REDDIT_USER_AGENT: ${{ secrets.REDDIT_USER_AGENT }}
      run: python headless_main.py
      
    # âœ‚ï¸ å·²åˆ é™¤ï¼šåŸæ¥çš„â€œå¤‡ä»½ä»Šæ—¥æ•°æ®â€æ­¥éª¤
    # å› ä¸º headless_main.py ä¸ä¼šåœ¨æœ¬åœ°ç”Ÿæˆæ–‡ä»¶ï¼Œä¿ç•™é‚£ä¸€æ­¥ä¼šå¯¼è‡´ Action æŠ¥é”™å˜çº¢
