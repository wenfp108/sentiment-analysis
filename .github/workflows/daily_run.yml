name: sentiment-analysis (Tor Edition)

on:
  schedule:
    - cron: '43 */4 * * *'  # æ¯ 4 å°æ—¶
  workflow_dispatch:

permissions:
  contents: read

jobs:
  analyze-and-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 40  # âš ï¸ æ—¢ç„¶ä½ å…è®¸æ…¢ï¼Œæˆ‘æŠŠè¶…æ—¶æ—¶é—´æ”¾å®½åˆ° 40 åˆ†é’Ÿ

    steps:
    - name: ğŸ“¥ æ‹‰å–ä»£ç 
      uses: actions/checkout@v3

    - name: ğŸ è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'

    - name: ğŸ§… å®‰è£… Tor æ´‹è‘±è·¯ç”± (æ ¸å¿ƒæ­¦å™¨)
      run: |
        sudo apt-get update
        sudo apt-get install -y tor
        
        # å¯åŠ¨ Tor æœåŠ¡
        sudo service tor start
        
        # ç­‰å¾… Tor å»ºç«‹é“¾è·¯ (ç¨å¾®ä¹…ä¸€ç‚¹ï¼Œç¡®ä¿è¿é€š)
        echo "â³ Waiting for Tor to bootstrap..."
        sleep 20
        
        # éªŒè¯ Tor æ˜¯å¦åœ¨ç›‘å¬ 9050 ç«¯å£
        if netstat -tuln | grep 9050; then
            echo "âœ… Tor is running on port 9050"
        else
            echo "âŒ Tor failed to start"
            exit 1
        fi

    - name: ğŸ§  ç¼“å­˜ HuggingFace æ¨¡å‹
      uses: actions/cache@v3
      with:
        path: ~/.cache/huggingface
        key: ${{ runner.os }}-hf-v1

    - name: âš¡ å®‰è£…ä¾èµ– (å« SOCKS æ”¯æŒ)
      run: |
        pip install --upgrade pip
        pip install torch --index-url https://download.pytorch.org/whl/cpu
        
        # requests[socks]: è®© Python èƒ½èµ° Tor ä»£ç†
        # stem: ç”¨äºæ§åˆ¶ Tor åˆ‡æ¢ IP (è™½ç„¶è¿™æ¬¡ä¸»è¦é å¤šé•œåƒ)
        pip install requests[socks] stem pandas numpy transformers
        
        # å®‰è£… NLP åº“
        pip install https://github.com/explosion/spacy-models/releases/download/en_core_web_sm-3.7.1/en_core_web_sm-3.7.1-py3-none-any.whl
        pip install textblob nltk contractions emoji spacy

    - name: ğŸ“¥ è¡¥å…… NLTK æ•°æ®
      run: |
        python -m nltk.downloader stopwords punkt wordnet averaged_perceptron_tagger

    - name: ğŸ¤– è¿è¡Œè„šæœ¬ (æ´‹è‘±æ¨¡å¼)
      env:
        GITHUB_TOKEN: ${{ secrets.GH_PAT }}
      run: python headless_main.py
