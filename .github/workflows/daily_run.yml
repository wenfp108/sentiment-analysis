name: Woonbot Sentinel

on:
  schedule:
    - cron: '43 */4 * * *'  # æ¯ 4 å°æ—¶ä¸€æ¬¡ (UTCæ—¶é—´)
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write          # å¿…é¡»æƒé™ï¼šå…è®¸å†™å…¥ JSON å›ä»“åº“

jobs:
  analyze-and-save:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ æ‹‰å–ä»£ç 
      uses: actions/checkout@v3

    - name: ğŸ è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        pip install requests                 # <--- å¿…é¡»åŠ è¿™è¡Œï¼Œç”¨äºè¿GitHub API
        pip install -r streamlit-app/requirements.txt
        python -m textblob.download_corpora

    - name: ğŸ¤– è¿è¡Œæƒ…ç»ªåˆ†æ
      env:
        # 1. ä½ çš„ GitHub ç§äººä»¤ç‰Œ (ç”¨äºè¯» Issue)
        GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        
        # 2. ä½ çš„ Reddit çˆ¬è™«å¯†é’¥
        REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
        REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
        REDDIT_USER_AGENT: ${{ secrets.REDDIT_USER_AGENT }}
      run: python headless_main.py

    - name: ğŸ’¾ æäº¤ç»“æœ
      run: |
        git config --global user.name "Woonbot Action"
        git config --global user.email "woonbot@github.com"
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å˜åŒ–
        if [[ -n $(git status -s) ]]; then
          git add sentiment_report.json
          git commit -m "ğŸ¤– Update sentiment report [skip ci]"
          git push
        else
          echo "æ²¡æœ‰æ•°æ®å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        fi
