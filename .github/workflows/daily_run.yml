name: Redditbot Sentinel (Turbo)

on:
  schedule:
    - cron: '43 */4 * * *'  # æ¯ 4 å°æ—¶ä¸€æ¬¡
  workflow_dispatch:        # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  analyze-and-save:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ æ‹‰å–ä»£ç 
      uses: actions/checkout@v3

    # ğŸ”¥ã€ä¼˜åŒ– 1ã€‘å¼€å¯ Python Pip ç¼“å­˜
    # è‡ªåŠ¨è¯†åˆ« requirements.txtï¼Œå¦‚æœæ–‡ä»¶æ²¡å˜ï¼Œç›´æ¥ä»ç¼“å­˜æ¢å¤æ‰€æœ‰åŒ…
    - name: ğŸ è®¾ç½® Python (é«˜é€Ÿç¼“å­˜ç‰ˆ)
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip' # å¼€å¯ pip ç¼“å­˜
        cache-dependency-path: streamlit-app/requirements.txt # æŒ‡å®šä¾èµ–è·¯å¾„

    # ğŸ”¥ã€ä¼˜åŒ– 2ã€‘ç¼“å­˜ NLTK è¯­æ–™åº“ (TextBlob)
    # é¿å…æ¯æ¬¡éƒ½å»è·‘ download_corpora
    - name: ğŸ§  ç¼“å­˜ NLTK æ•°æ®
      id: nltk-cache
      uses: actions/cache@v3
      with:
        path: ~/nltk_data
        key: ${{ runner.os }}-nltk-v1  # ç®€å•çš„ç¼“å­˜ Key

    - name: ğŸ“¦ å®‰è£…ä¾èµ– (æé€Ÿæ¨¡å¼)
      run: |
        # 1. å®‰è£… Python åŒ… (æœ‰ç¼“å­˜æ—¶è¿™ä¸€æ­¥ä¼šé£å¿«)
        pip install requests
        pip install -r streamlit-app/requirements.txt

        # 2. å¤„ç†è¯­æ–™åº“ (åªæœ‰ç¼“å­˜æ²¡å‘½ä¸­æ—¶æ‰ä¸‹è½½)
        if [ ! -d "$HOME/nltk_data" ]; then
          echo "ğŸ“¥ æœªæ£€æµ‹åˆ°ç¼“å­˜ï¼Œæ­£åœ¨ä¸‹è½½ NLTK è¯­æ–™åº“..."
          python -m textblob.download_corpora
        else
          echo "âœ… NLTK è¯­æ–™åº“å·²å‘½ä¸­ç¼“å­˜ï¼Œè·³è¿‡ä¸‹è½½ï¼"
        fi

    - name: ğŸ¤– è¿è¡Œæƒ…ç»ªåˆ†æ
      env:
        GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
        REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
        REDDIT_USER_AGENT: ${{ secrets.REDDIT_USER_AGENT }}
      run: python headless_main.py

    - name: ğŸ’¾ æäº¤ç»“æœ
      run: |
        git config --global user.name "Woonbot Action"
        git config --global user.email "woonbot@github.com"
        
        if [[ -n $(git status -s) ]]; then
          git add sentiment_report.json
          git commit -m "ğŸ¤– Update sentiment report [skip ci]"
          git push
        else
          echo "æ²¡æœ‰æ•°æ®å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        fi
